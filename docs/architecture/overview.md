# Godot-Modelica Integration Project

## Project Vision

This project enables **physics-based simulations** in the Godot game engine by bridging OpenModelica (industry-standard physics modeling) with Godot through Rust. It provides a generic, reusable system for integrating any Modelica model into Godot games.

## What Problem Does This Solve?

### The Challenge

Game developers who want realistic physics (thermal dynamics, electrical systems, fluid mechanics, etc.) typically must:
- Implement simplified physics manually in game code
- Sacrifice accuracy for performance
- Reinvent the wheel for each system
- Lack validation against real-world behavior

### The Solution

This project:
- ✅ Uses **OpenModelica** - industry-proven physics simulation
- ✅ Provides **Rust FFI** - safe, fast interface to compiled models
- ✅ Exposes **GDExtension** - native Godot integration
- ✅ Offers **generic architecture** - any Modelica model works
- ✅ Maintains **performance** - compiled C code, not interpreted

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                      Game Layer (GDScript)                  │
│  - Game logic, UI, player interaction                       │
│  - Uses domain-specific component wrappers                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              Component Wrappers (GDScript)                  │
│  - ThermalComponent, PowerComponent, etc.                   │
│  - Signals, helper methods, domain-specific API             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│            Generic Godot Extension (Rust/GDExtension)       │
│  - ModelicaNode: Universal interface to any model           │
│  - load_component(), set_input(), get_output(), step()      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                Rust FFI Layer (Rust)                        │
│  - Safe Rust wrappers around C functions                    │
│  - ModelicaRuntime: Manages simulation state                │
│  - SimulationComponent trait: Common interface              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│          Compiled Modelica Models (C/.so/.dll)              │
│  - Generated by OpenModelica compiler                        │
│  - High-performance simulation code                          │
│  - Based on .mo source files                                 │
└─────────────────────────────────────────────────────────────┘
```

## Repository Structure

### Root Directory
```
godot-colony-sim/
├── build.sh                        # Master build script
├── README.md                       # This file
│
├── godot-modelica-rust-integration/
│   └── modelica-rust-gdext/        # Rust integration code
│       ├── modelica-rust-ffi/      # FFI layer (Rust ↔ C)
│       ├── modelica-integration/   # GDExtension (Rust ↔ Godot)
│       └── godot/                  # Godot Rust bindings
│
└── lunco-sim/                      # Example game project
    ├── addons/                     # Deployment location
    ├── apps/                       # Game applications
    ├── scripts/                    # Game scripts
    └── scenes/                     # Game scenes
```

### Component Repositories

#### 1. modelica-rust-ffi
**Purpose:** Rust FFI layer to compiled Modelica components

**Key Files:**
- `build.rs` - Compiles C code, generates Rust bindings
- `src/runtime/modelica_runtime.rs` - Runtime wrapper
- `src/component.rs` - SimulationComponent trait
- `src/registry.rs` - Multi-component management

**Dependencies:**
- OpenModelica runtime libraries
- bindgen (for FFI generation)
- libc

**Documentation:** See `godot-modelica-rust-integration/modelica-rust-gdext/modelica-rust-ffi/README.md`

#### 2. modelica-integration
**Purpose:** Godot GDExtension that wraps FFI layer

**Key Files:**
- `src/modelica_node.rs` - ModelicaNode class
- `src/modelica_component.rs` - GenericModelicaComponent
- `src/lib.rs` - Extension registration
- `Cargo.toml` - Dependency configuration

**Dependencies:**
- godot-rust (GDExtension bindings)
- modelica-rust-ffi

**Documentation:** See [ModelicaNode Documentation](./modelica_node_docs.md)

#### 3. lunco-sim Integration
**Purpose:** Example game project using the integration

**Structure:**
```
lunco-sim/
├── addons/modelica_integration/    # Generic extension
├── apps/modelica/
│   ├── models/                     # .mo source files
│   ├── build/                      # Compiled models
│   ├── integration/                # GDScript wrappers
│   └── build_models.sh
├── scripts/systems/                # Game systems
└── scenes/systems/                 # Test scenes
```

**Documentation:** See [lunco-sim Integration Guide](./integration_guide.md)

## Key Concepts

### 1. Generic vs. Specific

**Generic Layer (modelica-integration addon):**
- No knowledge of specific models
- Provides ModelicaNode for ANY Modelica component
- Reusable across projects
- Maintained as separate addon

**Specific Layer (lunco-sim):**
- Contains specific .mo models
- Creates component wrappers (ThermalComponent, etc.)
- Implements game logic
- Project-specific

### 2. Component Lifecycle

```
1. Author .mo file → apps/modelica/models/SimpleThermalMVP.mo
2. Compile → ./build_models.sh → apps/modelica/build/SimpleThermalMVP/
3. FFI links → modelica-rust-ffi references compiled C code
4. Extension wraps → ModelicaNode can load "SimpleThermalMVP"
5. Game uses → ThermalComponent wraps ModelicaNode
6. System logic → ThermalSystem uses ThermalComponent
```

### 3. Data Flow

**Input Flow (Game → Physics):**
```
Game Logic
  → thermal_system.set_heater(true)
    → thermal_component.set_heater(true)
      → modelica_node.set_bool_input("heaterOn", true)
        → FFI sets variable in C simulation
```

**Output Flow (Physics → Game):**
```
C simulation calculates new temperature
  → FFI reads variable
    → modelica_node.get_real_output("temperature")
      → thermal_component.temperature property
        → Signal: temperature_changed.emit()
          → Game UI updates
```

**Simulation Step:**
```
Every frame:
  Godot _process(delta)
    → modelica_node._process(delta)
      → component.step(delta)
        → FFI advances simulation by delta seconds
```

## Use Cases

### 1. Colony Simulation (lunco-sim)
**Systems:**
- Thermal management (heating/cooling)
- Life support (O2, CO2, pressure)
- Power generation and distribution
- Resource production and consumption

**Benefits:**
- Realistic thermal dynamics
- Accurate power calculations
- Validated against real spacecraft systems
- Educational value

### 2. Vehicle Simulation
**Possible Systems:**
- Engine thermodynamics
- Electrical system
- Suspension dynamics
- Aerodynamics

### 3. Industrial Process Games
**Possible Systems:**
- Chemical reactions
- Fluid flow
- Heat exchangers
- Control systems

### 4. Educational Simulations
**Benefits:**
- Real physics equations
- Visualize complex systems
- Interactive learning
- Accurate behavior

## Development Workflow

### Quick Start

```bash
# 1. Clone repository
git clone <repo-url>
cd godot-colony-sim

# 2. Build everything
./build.sh

# 3. Open in Godot
cd lunco-sim
godot --editor .

# 4. Run test scene
# Open scenes/systems/thermal_habitat.tscn
# Press F5
```

### Adding a New Component

**Step 1: Create Modelica Model**
```bash
cd lunco-sim/apps/modelica/models
vim SolarPanel.mo
```

**Step 2: Build**
```bash
./build_models.sh
```

**Step 3: Create GDScript Wrapper**
```bash
cd ../integration
vim solar_panel_component.gd
```

**Step 4: Create Game System**
```bash
cd ../../../scripts/systems
vim power_system.gd
```

**Step 5: Test**
- Create test scene
- Add PowerSystem node
- Run and verify

### Updating Existing Component

```bash
# Edit model
vim lunco-sim/apps/modelica/models/SimpleThermalMVP.mo

# Rebuild
cd lunco-sim/apps/modelica
./build_models.sh

# Rebuild extension (detects changes automatically)
cd ../../..
./build.sh

# Restart Godot to reload extension
```

## Performance Characteristics

### Simulation Speed
- **Compiled C code** - Same performance as native OpenModelica
- **Rust FFI overhead** - Minimal (nanoseconds per call)
- **GDExtension overhead** - Minimal (native code, not GDScript)

### Typical Performance
- Simple models (5-10 equations): **<0.1ms per step**
- Medium models (50-100 equations): **~1ms per step**
- Complex models (500+ equations): **~10ms per step**

### Scaling
- **Multiple components**: Linear scaling (N components = N × time)
- **Future optimization**: Parallel stepping of independent components

### Memory Usage
- Per component: **~1-10 KB** (depends on model complexity)
- Runtime overhead: **~100 KB** (FFI, Godot integration)

## Platform Support

### Currently Supported
- ✅ **macOS** (Intel and Apple Silicon)
  - Tested on macOS 13+
  - OpenModelica via Homebrew or official installer

### Planned Support
- 🟡 **Linux** (Ubuntu, Fedora)
  - Should work with path adjustments
  - OpenModelica via package manager

- 🟡 **Windows** (10/11)
  - Requires MSVC or MinGW toolchain
  - OpenModelica Windows build

### Build Matrix

| Platform | OpenModelica | Rust | Godot | Status |
|----------|--------------|------|-------|--------|
| macOS (ARM64) | ✅ | ✅ | ✅ | Working |
| macOS (x86_64) | ✅ | ✅ | ✅ | Working |
| Linux (x86_64) | 🟡 | ✅ | ✅ | Untested |
| Windows (x86_64) | 🟡 | ✅ | ✅ | Untested |

## Dependencies

### Build Dependencies
- **OpenModelica** (≥1.26.0) - Model compilation
- **Rust** (≥1.70) - FFI and extension code
- **Clang/LLVM** - Required by bindgen
- **CMake** - For building some dependencies

### Runtime Dependencies
- **Godot Engine** (≥4.2) - Game engine
- **OpenModelica Runtime** - Simulation libraries
  - libSimulationRuntimeC
  - libOpenModelicaRuntimeC
  - libomcgc

### Installation

**macOS:**
```bash
# OpenModelica
brew install openmodelica

# Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Godot
brew install godot
```

**Linux:**
```bash
# OpenModelica
sudo apt-get install openmodelica

# Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Godot
# Download from godotengine.org
```

## Testing

### Unit Tests (Rust)
```bash
cd godot-modelica-rust-integration/modelica-rust-gdext/modelica-rust-ffi
cargo test
```

### Integration Tests (Godot)
```bash
cd lunco-sim
godot --headless --path . --script test_thermal_component.gd
```

### Manual Testing
1. Open test scene in Godot
2. Press F5 to run
3. Observe console output
4. Verify visual behavior

## Troubleshooting

### Common Issues

**Build Failures**
- See [Build System Documentation](./build_system_docs.md)

**Component Won't Load**
- See [Integration Guide](./integration_guide.md)

**Performance Issues**
- Profile with Godot profiler
- Check model complexity
- Verify release build

**Platform-Specific Issues**
- Check OpenModelica installation
- Verify library paths in build.rs
- Consult platform-specific documentation

## Contributing

### Code Style
- **Rust:** Follow rustfmt defaults
- **GDScript:** Follow Godot style guide
- **Modelica:** Follow Modelica style guide

### Pull Request Process
1. Create feature branch
2. Update documentation
3. Add tests
4. Ensure build passes
5. Submit PR with description

### Areas for Contribution
- [ ] Linux/Windows support
- [ ] Additional example models
- [ ] Performance optimizations
- [ ] State serialization
- [ ] Better error messages
- [ ] Component introspection
- [ ] Parallel simulation

## Roadmap

### Phase 1: Foundation (Complete)
- [x] Basic FFI layer
- [x] Generic GDExtension
- [x] Example thermal model
- [x] Build system
- [x] Documentation

### Phase 2: Enhanced Features (Current)
- [ ] Additional example models
- [ ] Component introspection
- [ ] Better error handling
- [ ] State save/load
- [ ] Performance profiling

### Phase 3: Production Ready
- [ ] Cross-platform support
- [ ] Comprehensive test suite
- [ ] CI/CD pipeline
- [ ] Tutorial series
- [ ] Example projects

### Phase 4: Advanced Features
- [ ] Parallel simulation
- [ ] Network synchronization
- [ ] FMU export
- [ ] Visual model editor
- [ ] Optimization tools

## License

[Specify license - typically MIT or GPL to match OpenModelica]

## Acknowledgments

- **OpenModelica** - Physics simulation foundation
- **godot-rust** - Rust GDExtension bindings
- **lunco-sim** - Example game project

## Contact & Support

- **Issues:** [GitHub Issues](https://github.com/your-repo/issues)
- **Discussions:** [GitHub Discussions](https://github.com/your-repo/discussions)
- **Documentation:** This repository

## See Also

- [ModelicaNode Documentation](./modelica_node_docs.md)
- [Build System Documentation](./build_system_docs.md)
- [Integration Guide](./integration_guide.md)
- [Rust FFI README](./godot-modelica-rust-integration/modelica-rust-gdext/modelica-rust-ffi/README.md)
- [OpenModelica Documentation](https://openmodelica.org/doc/)
- [Godot Engine Documentation](https://docs.godotengine.org/)
- [Rust Language Documentation](https://doc.rust-lang.org/)